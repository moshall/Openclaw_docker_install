# OpenClaw Docker 交互式部署助手（中文）

一个面向 OpenClaw 的交互式 Shell 工具，用于在 Docker 环境中快速完成：
- 新装
- 安全升级（保留持久化数据）
- 卸载（保留或清理持久化数据）
- 仅升级 Openclaw_Easy_Cli
- 容器环境依赖检测/安装（默认 `npm` + `uv`，`go` 可选）
- 小白级“按步骤跟随”操作

本项目核心目标：
- 减少重复输入冗长命令
- 降低误操作风险（提供预览与确认）
- 统一部署流程，便于长期维护

## 功能特性

- 交互式菜单（清单式多层）
  - `1) 新装（清单模式）`
  - `2) 升级（安全升级 / 清单模式）`
  - `3) 卸载（快捷模式）`
  - `4) 仅升级 Easy CLI`
  - `5) 组件与依赖管理`
- 新装可配置项
  - 以“必要信息清单”形式展示，未填写项会显示 `未选择`
  - 按编号进入子菜单修改，避免长串连续提问
  - 镜像来源与通道（官方/中文、稳定/最新版）
  - 宿主机端口、容器端口
  - 扩展端口映射（可选，支持一次配置多个 `-p`，如 `5001:5001,6000:6000/udp`）
  - 容器名
  - 持久化目录
  - 运行时持久化策略（可选）
    - `bin` 持久化（默认开启）
    - 环境持久化（默认关闭，可按需开启）
  - `gateway.bind`（`local` / `lan`）
  - Token（自动生成/手动输入）
  - 可选安装 `Openclaw_Easy_Cli`
    - 安装目录：`<持久化目录>/software/easy_cli`
    - 兼容旧目录：若检测到历史 `Openclaw_Easy_Cli`，脚本会自动迁移
  - 可选自动补齐容器内常见依赖（默认 `npm` + `uv`，`go` 可选）
  - 失败降级：依赖/Easy CLI 属于可选步骤，失败不会阻断主应用安装，仍会回显 Token/访问 URL
- 预检查（Preflight）
  - 执行前自动检查 Docker 可用性、宿主系统信息、目录可写性、镜像仓库目标
  - 若发现旧安装痕迹，会提示“兼容迁移识别”
- 依赖检测/安装
  - 自动识别容器内包管理器：`apt` / `apk` / `dnf` / `yum`
  - 自动识别容器架构：`x86_64` / `aarch64`（安装 Go 时选择对应安装方式）
  - 自动修正 `uv` / `go` 的 PATH（当前会话 + 持久化 profile）
  - 当选择 `uv` 但容器缺失 Python 时，会自动补齐 `python3/pip`
  - 已内置 Debian/Ubuntu 兼容模式：若遇到 PEP668（`externally-managed-environment`），会自动回退安装策略
  - 自动将 `/root/.local/bin`、`/root/go/bin` 中可执行文件软链到 `/usr/local/bin`，避免 OpenClaw 找不到命令
  - 依赖清单会写入持久化目录（`runtime/deps.profile`），升级后自动沿用并补齐
  - 按选项挂载并持久化
    - `bin`：`/root/.local/bin`、`/root/go/bin`
    - 环境：`/usr/local/go`、`/usr/local/lib/node_modules`、`/root/.local/lib`、`/root/.local/share/uv`、`/root/.local/pipx`、`/root/.local/share/pipx`
  - 支持两种模式：仅检测、检测并安装缺失项
  - 可在安装流程自动执行，也可菜单独立执行
- 安全升级
  - 以“升级清单”形式展示所有关键参数，支持逐项编辑
  - 输入容器名后会先展示“升级前环境检测”摘要（依赖检测、runtime目录、挂载状态、风险建议）
  - 自动检测当前容器已发布端口：主端口自动识别，其余端口自动填入“扩展端口映射”
  - 在最终执行前会再次检查容器运行状态；若仍在运行，会提示“将中断当前任务”并二次确认
  - 自动识别“非本脚本历史安装”场景并尝试读取容器内已安装依赖，作为默认依赖清单
  - 升级前检测容器运行状态（运行中会提示“将中断任务”并要求确认）
  - 若本次开启了 `bin/env` 持久化，会在删除旧容器前先尝试迁移对应 runtime 目录，降低首次开启持久化时的重装成本
  - 若检测到“已持久化且路径一致”，会自动跳过迁移（提速）；若检测到路径变化，会执行迁移并提示路径变更信息
  - 复用原持久化目录
  - 支持在升级时同步调整“扩展端口映射”，与升级一次完成，避免升级后再为端口单独重建
  - 重建容器后自动做基础检查（`ps/logs/version`）
  - 可选检查并升级 `Openclaw_Easy_Cli`（若未安装会自动创建并安装）
  - 失败降级：可选步骤失败不阻断升级主流程，结尾会给出失败摘要
  - 可继承并调整“bin/环境持久化”与依赖选择（配置保存于 `runtime/` 下）
- 卸载模式
  - 安全卸载：仅删除容器
  - 完整卸载：删除容器 + 删除持久化目录（二次确认）
- Dry Run 预演
  - `--dry-run` 只打印命令，不执行
- 运行报告
  - 每次执行后写入 `runtime/last_report.json`（结构化结果）
  - 同步追加 `runtime/diagnostics.log`（排障日志）

## 镜像映射规则

- 中文稳定：`ghcr.io/1186258278/openclaw-zh:latest`
- 中文最新版：`ghcr.io/1186258278/openclaw-zh:nightly`
- 官方稳定：`docker.io/openclaw/openclaw:latest`
- 官方最新版：`docker.io/openclaw/openclaw:beta`

## 环境要求

- Linux 服务器（推荐）
- Docker 已安装并可用
- Bash 可用（脚本使用了 `bash` 语法）
- 可选：`git`（用于安装/升级 `Openclaw_Easy_Cli`）

## 适配声明（发布前必读）

- 本脚本目前仅在 **1Panel 面板环境** 下完成实装与验证。
- 其他面板或纯 Docker 管理环境（如宝塔、青龙、Portainer、自建脚本环境）**尚未完成完整验证**。
- 若你在非 1Panel 环境使用遇到问题，请反馈完整报错信息，建议至少包含：
  - 执行命令
  - 报错原文（不要只截图结论）
  - `docker version`
  - `cat /etc/os-release`
  - 使用的菜单路径（如 `1) 新装 -> 10) 依赖清单 -> c`）
- 追求稳定性时，**推荐优先在 1Panel 中使用本脚本**。

## 快速开始

### 1) 获取脚本

将本仓库克隆到服务器后，进入目录：

```bash
cd /你的路径/openclaw\ docker/Openclaw_docker_install
```

### 2) 运行（重要）

请使用 `bash` 运行，不要用 `sh`：

```bash
bash ./openclawctl.sh
```

预演模式：

```bash
bash ./openclawctl.sh --dry-run
```

### 3) 按菜单完成操作

脚本会逐步询问参数并在关键步骤提供确认。

## 小白跟随操作（建议先看）

下面按“第一次安装”给出最简流程，直接照着做即可。

1. 进入脚本目录并启动：

```bash
cd /你的路径/openclaw\ docker/Openclaw_docker_install
bash ./openclawctl.sh
```

2. 进入主菜单后输入 `1`，进入 `新装（清单模式）`。
3. 在清单页面按编号填写必要项：
  - `1` 选择版本（官方/中文版、稳定/最新版）
  - `2` 填写容器名（建议英文+数字，如 `ddy_claw`）
  - `3` 确认端口（默认可直接用）
  - `4` 确认持久化目录（默认可直接用）
4. 可选项按需设置：
  - `6` 持久化策略（新手建议：`bin=是`、`env=否`）
  - `7` 是否安装 Easy CLI（默认是）
  - `8` Token 方式（默认自动生成）
  - `9` 是否做依赖补齐（默认是）
  - `10` 依赖清单（默认 `npm+uv`，`go`按需）
5. 输入 `c` 查看“执行清单（确认前）”，确认后输入 `y` 执行。
6. 安装结束后记录脚本回显的：
  - `TOKEN=...`
  - `URL=http://<server-ip>:端口/?token=...`
7. 浏览器打开该 URL 即可访问。

## 零基础跟随安装（一步一回车版）

如果你是第一次接触 Docker/OpenClaw，可以直接按下面做：

1. 执行 `bash ./openclawctl.sh`，主菜单输入 `1` 进入新装。
2. 清单里优先处理 4 个关键项：
  - `1) 版本`：按需选“官方/中文版 + 稳定/最新版”。
  - `2) 容器名`：建议 `ddy_claw` 这种英文名。
  - `3) 端口`：不冲突就直接回车用默认值。
  - `4) 持久化目录`：不确定就直接回车用默认值。
3. 其余建议新手先用默认：
  - `6) 持久化策略`：`bin=是`，`env=否`。
  - `7) Easy CLI`：是。
  - `8) Token`：自动生成。
  - `9) 依赖补齐`：是。
  - `10) 依赖清单`：保留 `npm+uv`，`go`按需。
4. 输入 `c` 查看执行清单，再输入 `y` 执行。
5. 结束后复制脚本回显的 `URL` 与 `TOKEN` 打开即可使用。

提示：
- 看到 `[...] [回车使用默认值]` 时，直接按回车就是推荐配置。
- 卸载流程里“持久化目录”那一行，如果不改目录，直接回车即可。

## 常见使用场景

### 场景 A：首次部署（中文版稳定）

1. 选择 `1) 新装（清单模式）`
2. 在清单中编辑 `1)版本`、`2)容器名`、`4)持久化目录` 等必要项
3. 未填写项会显示 `未选择`，可随时回改
4. 配置完成后输入 `c` 进入最终确认并执行

### 场景 B：升级 OpenClaw 且保留数据

1. 选择 `2) 升级（安全升级 / 清单模式）`
2. 输入容器名
3. 若检测到容器运行中，确认是否继续（继续会中断当前任务）
4. 在“升级清单”中按编号调整目标版本、持久化策略、依赖项、扩展端口映射
5. 输入 `c` 进入确认并执行

### 场景 E：一次性配置额外端口（避免后续单独重建）

1. 新装或升级流程中，编辑 `扩展端口映射`
2. 输入格式：`宿主机端口:容器端口`，多个用逗号分隔
3. 支持协议后缀：`/udp`（如 `6000:6000/udp`）
4. 示例：`5001:5001,6000:6000/udp`

### 场景 C：只升级 Easy CLI，不动 OpenClaw 容器

1. 选择 `4) 仅升级 Easy CLI`
2. 输入容器名/目录
3. 确认执行

### 场景 D：只做容器依赖补齐（默认 npm+uv，go 可选）

1. 选择 `5) 组件与依赖管理`
2. 输入容器名
3. 选择“仅检测”或“检测并安装缺失项”
4. 确认执行

## 目录结构

```text
.
├── Openclaw_docker_install/
│   ├── openclawctl.sh            # 主脚本（交互式菜单）
│   └── README.md                 # 当前文件
└── tests/
    └── openclawctl_test.sh       # 交互流程测试
```

## 注意事项

- `sh openclawctl.sh` 报错 `Illegal option -o pipefail`：
  - 原因：`sh` 不支持该语法
  - 解决：改用 `bash openclawctl.sh`
- 出现多个 `openclaw.json.bak*`：
  - 属于配置写入时的备份行为，通常是正常现象
- 删除持久化目录是不可逆操作：
  - 完整卸载前请确认数据已备份
- 若使用 `pip install --user` 安装 Python 包：
  - 其 `site-packages` 常在 `/root/.local/lib/python*/site-packages`
  - 当前版本已将 `/root/.local/lib` 纳入“环境持久化”范围
- 若使用 `npm -g` 安装包：
  - 常见目录为 `/usr/local/lib/node_modules`
  - 当前版本已将该目录纳入“环境持久化”范围
- 系统包管理器安装内容（`apt/apk/dnf/yum`）：
  - 属于容器系统层，不属于目录挂载持久化范畴
  - 升级后建议通过“依赖补齐”或手动命令重新安装

## 为什么建议开启持久化

- 开启 `bin` 持久化后：
  - 升级后已安装命令更不容易“丢失路径”（如 `uv`、`obsidian-cli`）
- 同时开启环境持久化后：
  - 升级后已安装运行环境可复用，减少重复安装
  - 对 `go`、`uv`、`npm -g`、`pip --user` 场景更友好
- 对 OpenClaw 使用的直接收益：
  - 升级时更不容易丢失已安装技能/插件所依赖的运行时命令

## 测试

运行测试：

```bash
bash ../tests/openclawctl_test.sh
```

## 许可证

当前仓库未单独声明 License。
如需开源发布，建议补充 `LICENSE` 文件（如 MIT/Apache-2.0）。

## 致谢

- OpenClaw 官方项目：<https://github.com/openclaw/openclaw>
- OpenClaw 中文版项目：<https://github.com/1186258278/OpenClawChineseTranslation>
- Openclaw_Easy_Cli：<https://github.com/moshall/Openclaw_Easy_Cli>
